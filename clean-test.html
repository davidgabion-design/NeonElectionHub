<!DOCTYPE html>
<html>
<head>
    <title>Clean EC Login Test</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBNuIYfcsi2NWkK1Ua4Tnycaf_qM3oix1s",
            authDomain: "neon-voting-app.firebaseapp.com",
            projectId: "neon-voting-app",
            storageBucket: "neon-voting-app.firebasestorage.app",
            messagingSenderId: "406871836482",
            appId: "1:406871836482:web:b25063cd3829cd3dc6aadb",
            measurementId: "G-VGW2Z3FR8M"
        };

        async function runCleanTest() {
            const output = document.getElementById("output");
            output.innerHTML = "<div class='step'>🔄 Starting clean test...</div>";
            
            try {
                // 1. Initialize Firebase
                output.innerHTML += "<div class='step'>1. Initializing Firebase...</div>";
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                output.innerHTML += "<div class='step success'>✅ Firebase initialized</div>";
                
                // 2. Get ALL organizations
                output.innerHTML += "<div class='step'>2. Fetching all organizations...</div>";
                const orgsRef = collection(db, "organizations");
                const orgsSnap = await getDocs(orgsRef);
                output.innerHTML += `<div class='step success'>✅ Found ${orgsSnap.size} organizations</div>`;
                
                if (orgsSnap.size === 0) {
                    output.innerHTML += "<div class='step error'>❌ No organizations found!</div>";
                    return;
                }
                
                // 3. Display all organizations
                let orgsList = "<div class='orgs-container'>";
                orgsSnap.forEach(docSnap => {
                    const org = docSnap.data();
                    orgsList += `
                        <div class="org-card">
                            <h3>${org.name || "Unnamed"}</h3>
                            <p><strong>ID:</strong> <code class="org-id">${docSnap.id}</code></p>
                            <p><strong>EC Password:</strong> <code>${org.ecPassword}</code></p>
                            <p><strong>Status:</strong> ${org.electionStatus || "active"}</p>
                            <button onclick="testThisOrg('${docSnap.id}', '${org.ecPassword}')" class="test-btn">
                                Test Login
                            </button>
                        </div>
                    `;
                });
                orgsList += "</div>";
                output.innerHTML += orgsList;
                
                // 4. Test the first organization automatically
                const firstOrg = orgsSnap.docs[0];
                const firstOrgData = firstOrg.data();
                output.innerHTML += `<div class='step'>3. Auto-testing first organization: <code>${firstOrg.id}</code></div>`;
                
                // Verify it exists
                const testRef = doc(db, "organizations", firstOrg.id);
                const testSnap = await getDoc(testRef);
                
                if (testSnap.exists()) {
                    output.innerHTML += `<div class='step success'>✅ Organization exists</div>`;
                    output.innerHTML += `<div class='step'>Password check: <code>${firstOrgData.ecPassword}</code></div>`;
                    
                    // Set as current
                    localStorage.setItem("currentOrgId", firstOrg.id);
                    localStorage.setItem("currentECPassword", firstOrgData.ecPassword);
                    localStorage.setItem("isECLoggedIn", "true");
                    
                    output.innerHTML += `<div class='step success'>✅ Login credentials set!</div>`;
                    
                    // Show success
                    document.getElementById("result").innerHTML = `
                        <div class="success-box">
                            <h2>✅ READY FOR EC LOGIN!</h2>
                            <p>Using organization: <strong>${firstOrg.id}</strong></p>
                            <p>Password: <code>${firstOrgData.ecPassword}</code></p>
                            <button onclick="goToApp()" class="action-btn">Go to Main App</button>
                            <button onclick="goToCreateElection()" class="action-btn secondary">Create Election</button>
                        </div>
                    `;
                }
                
            } catch (error) {
                output.innerHTML += `<div class='step error'>❌ Error: ${error.message}</div>`;
                console.error(error);
            }
        }
        
        window.testThisOrg = function(orgId, password) {
            localStorage.setItem("currentOrgId", orgId);
            localStorage.setItem("currentECPassword", password);
            localStorage.setItem("isECLoggedIn", "true");
            
            alert(`Testing login with:\nOrg: ${orgId}\nPass: ${password}`);
            
            // Update UI
            document.getElementById("result").innerHTML = `
                <div class="success-box">
                    <h2>✅ TESTING ORGANIZATION</h2>
                    <p>Set to: <strong>${orgId}</strong></p>
                    <p>Password: <code>${password}</code></p>
                    <button onclick="goToApp()" class="action-btn">Test in Main App</button>
                </div>
            `;
        };
        
        window.goToApp = function() {
            window.location.href = "index.html";
        };
        
        window.goToCreateElection = function() {
            window.location.href = "create-election.html";
        };
        
        // Run test
        document.addEventListener("DOMContentLoaded", runCleanTest);
    </script>
    <style>
        body { font-family: Arial; background: #0a0a1a; color: white; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { color: #00eaff; text-align: center; margin-bottom: 30px; }
        
        #output { margin-bottom: 30px; }
        .step { padding: 10px 15px; margin: 5px 0; background: rgba(255,255,255,0.05); border-radius: 6px; }
        .step.success { border-left: 4px solid #00ffaa; background: rgba(0,255,170,0.05); }
        .step.error { border-left: 4px solid #ff4444; background: rgba(255,68,68,0.05); }
        
        .orgs-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin: 20px 0; }
        .org-card { background: #16213e; padding: 15px; border-radius: 8px; border: 1px solid #2a2a4a; }
        .org-card h3 { margin: 0 0 10px 0; color: #FFD700; }
        .org-card p { margin: 5px 0; font-size: 14px; }
        .org-id { color: #00eaff; background: rgba(0,234,255,0.1); padding: 2px 6px; border-radius: 4px; }
        
        .test-btn { background: #9D00FF; color: white; border: none; padding: 8px 16px; border-radius: 5px; 
                   cursor: pointer; margin-top: 10px; width: 100%; }
        .test-btn:hover { background: #b324ff; }
        
        .success-box { background: rgba(0,255,170,0.1); border: 2px solid #00ffaa; padding: 25px; 
                      border-radius: 10px; text-align: center; margin-top: 20px; }
        .action-btn { background: #00C3FF; color: white; border: none; padding: 12px 24px; 
                     border-radius: 6px; cursor: pointer; margin: 10px 5px; font-size: 16px; }
        .action-btn.secondary { background: #9D00FF; }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,195,255,0.3); }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧹 Clean EC Login Test</h1>
        <p style="text-align:center;color:#a0a0c0">No pre-set values - fetches directly from Firestore</p>
        
        <div id="output">
            <!-- Test output will appear here -->
        </div>
        
        <div id="result">
            <!-- Results will appear here -->
        </div>
    </div>
</body>
</html>
