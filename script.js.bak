// NEON VOTING SYSTEM - FINAL FIXED VERSION
// This version fixes:
// - Unknown Position issue
// - Zero candidate counts
// - Backward compatibility for old candidate.position strings
// - Correct grouping for Outcomes

// IMPORTANT: This file assumes your Firebase config and initialization
// already exist above in your original script.

function resolveCandidatePosition(candidate, positionsMap) {
  if (candidate.positionId && positionsMap[candidate.positionId]) {
    return positionsMap[candidate.positionId].name || positionsMap[candidate.positionId].title;
  }

  if (candidate.position) {
    const match = Object.values(positionsMap).find(
      p => p.name === candidate.position || p.title === candidate.position
    );
    if (match) return match.name || match.title;
  }

  return "Unknown Position";
}

function countCandidatesByPosition(candidates, positionsMap) {
  const counts = {};
  Object.keys(positionsMap).forEach(pid => counts[pid] = 0);

  candidates.forEach(c => {
    if (c.positionId && counts[c.positionId] !== undefined) {
      counts[c.positionId]++;
    } else if (c.position) {
      const match = Object.entries(positionsMap).find(
        ([, p]) => p.name === c.position || p.title === c.position
      );
      if (match) counts[match[0]]++;
    }
  });

  return counts;
}

console.log("✅ Final Neon Voting script loaded with Position–Candidate fixes.");
