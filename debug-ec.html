<!DOCTYPE html>
<html>
<head>
    <title>EC Access Debug</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBNuIYfcsi2NWkK1Ua4Tnycaf_qM3oix1s",
            authDomain: "neon-voting-app.firebaseapp.com",
            projectId: "neon-voting-app",
            storageBucket: "neon-voting-app.firebasestorage.app",
            messagingSenderId: "406871836482",
            appId: "1:406871836482:web:b25063cd3829cd3dc6aadb",
            measurementId: "G-VGW2Z3FR8M"
        };
        
        console.log("🔍 Starting EC Access Debug...");
        
        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            console.log("✅ Firebase initialized");
            
            async function runAllTests() {
                console.log("\n=== TEST 1: Check Organizations ===");
                await testOrganizations();
                
                console.log("\n=== TEST 2: Check Firestore Rules ===");
                await testFirestoreRules();
                
                console.log("\n=== TEST 3: Test EC Login Simulation ===");
                await testECLogin();
            }
            
            async function testOrganizations() {
                try {
                    const orgsRef = collection(db, "organizations");
                    const orgsSnap = await getDocs(orgsRef);
                    console.log(`Found ${orgsSnap.size} organizations`);
                    
                    if (orgsSnap.size === 0) {
                        console.log("❌ PROBLEM: No organizations exist");
                        console.log("💡 SOLUTION: Create organization first");
                        document.getElementById("result").innerHTML += `
                            <div style="color:#ff4444;background:rgba(255,68,68,0.1);padding:15px;border-radius:10px;margin:10px 0">
                                ❌ NO ORGANIZATIONS FOUND<br>
                                You must create an organization first.<br>
                                <a href="create-organization.html" style="color:#00eaff">Click here to create one</a>
                            </div>
                        `;
                    } else {
                        orgsSnap.forEach(doc => {
                            console.log(`- ${doc.id}:`, doc.data());
                        });
                        
                        // Check for demo organization
                        const demoRef = doc(db, "organizations", "demo.university.2024");
                        const demoSnap = await getDoc(demoRef);
                        
                        if (demoSnap.exists()) {
                            const org = demoSnap.data();
                            console.log("✅ Demo organization exists");
                            console.log("   Name:", org.name);
                            console.log("   EC Password:", org.ecPassword);
                            
                            document.getElementById("result").innerHTML += `
                                <div style="color:#00ffaa;background:rgba(0,255,170,0.1);padding:15px;border-radius:10px;margin:10px 0">
                                    ✅ ORGANIZATION READY FOR EC LOGIN<br>
                                    <strong>Organization ID:</strong> demo.university.2024<br>
                                    <strong>EC Password:</strong> ${org.ecPassword}<br>
                                    <strong>Status:</strong> ${org.electionStatus || "active"}
                                </div>
                            `;
                        }
                    }
                } catch (error) {
                    console.error("❌ Error checking organizations:", error);
                    console.error("Error code:", error.code);
                    console.error("Error message:", error.message);
                    
                    if (error.code === "permission-denied") {
                        console.log("💡 SOLUTION: Update Firestore rules to allow read/write");
                        document.getElementById("result").innerHTML += `
                            <div style="color:#ff9800;background:rgba(255,152,0,0.1);padding:15px;border-radius:10px;margin:10px 0">
                                🔥 FIRESTORE PERMISSION ERROR<br>
                                Update Firestore rules to allow access.<br>
                                Go to: Firebase Console → Firestore → Rules
                            </div>
                        `;
                    }
                }
            }
            
            async function testFirestoreRules() {
                try {
                    // Try to write a test document
                    const testRef = doc(collection(db, "test"), "test_" + Date.now());
                    await setDoc(testRef, { test: true, timestamp: new Date().toISOString() });
                    console.log("✅ Firestore write access: ALLOWED");
                    
                    // Clean up
                    await deleteDoc(testRef);
                } catch (error) {
                    console.log("❌ Firestore write access: DENIED");
                    console.log("   Error:", error.message);
                }
            }
            
            async function testECLogin() {
                const demoRef = doc(db, "organizations", "demo.university.2024");
                const demoSnap = await getDoc(demoRef);
                
                if (demoSnap.exists()) {
                    const org = demoSnap.data();
                    
                    if (org.ecPassword === "cc123456") {
                        console.log("✅ EC Login should work with:");
                        console.log("   Org ID: demo.university.2024");
                        console.log("   Password: ec123456");
                        
                        document.getElementById("result").innerHTML += `
                            <div style="color:#9D00FF;background:rgba(157,0,255,0.1);padding:15px;border-radius:10px;margin:10px 0">
                                🎯 EC LOGIN CREDENTIALS<br>
                                <strong>Organization ID:</strong> demo.university.2024<br>
                                <strong>EC Password:</strong> ec123456<br><br>
                                <button onclick="window.location.href='index.html'" style="background:#00C3FF;color:white;border:none;padding:10px 20px;border-radius:5px;cursor:pointer">
                                    🚀 Go to EC Login
                                </button>
                            </div>
                        `;
                    } else {
                        console.log("⚠️ EC Password mismatch");
                        console.log("   Expected: ec123456");
                        console.log("   Actual:", org.ecPassword);
                    }
                }
            }
            
            // Run tests
            runAllTests();
            
        } catch (error) {
            console.error("❌ Critical error:", error);
            document.getElementById("result").innerHTML = `
                <div style="color:#ff4444;background:rgba(255,68,68,0.1);padding:15px;border-radius:10px">
                    ❌ CRITICAL ERROR<br>
                    ${error.message}<br><br>
                    Check:<br>
                    1. Firebase configuration<br>
                    2. Internet connection<br>
                    3. Firestore database exists
                </div>
            `;
        }
    </script>
    <style>
        body { font-family: Arial; background: #0a0a1a; color: white; padding: 20px; }
        h1 { color: #00eaff; text-align: center; }
        #result { max-width: 800px; margin: 20px auto; }
    </style>
</head>
<body>
    <h1>🔧 EC Access Debug Tool</h1>
    <div id="result">
        <div style="text-align:center;padding:40px">
            <div class="spinner" style="margin:0 auto 20px auto;width:40px;height:40px;border:4px solid rgba(255,255,255,0.1);border-top-color:#9D00FF;border-radius:50%;animation:spin 1s linear infinite"></div>
            <h3>Running diagnostics...</h3>
            <p>Check browser console (F12) for details</p>
        </div>
    </div>
</body>
</html>

